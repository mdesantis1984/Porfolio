@page "/login"
@rendermode RenderMode.InteractiveServer
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Web

@inject NavigationManager url
@inject LinkedinService linkedinService
@inject ILocalStorageService StorageService
@inject IOptions<OAuth2Services> OAuth2Options

@code {

    public bool isInitialized = false;
    public User profile;

   public string CodeUri { get; set; } = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!string.IsNullOrEmpty(url.Uri))
            {
                if (profile == null)
                {
                    CodeUri = url.Uri;

                    if (CodeUri.Contains("code"))
                    {
                        var _authorizationCode = CodeUri.Split('?')[1].Split('=')[1];

                        await linkedinService.SaveProfile(_authorizationCode);

                        url.NavigateTo("/Home");
                    }
                    else
                    {
                        var authorizationEndpoint = "https://www.linkedin.com/oauth/v2/authorization";
                        var authorizationRequest = $"{authorizationEndpoint}?response_type=code&client_id={OAuth2Options.Value.OAuth2.client_id}&redirect_uri={OAuth2Options.Value.OAuth2.redirect_uri}&scope={OAuth2Options.Value.OAuth2.scope}";

                        url.NavigateTo(authorizationRequest);
                        StateHasChanged();
                    }
                }
            }
        }
    }
}